<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è¨ˆç°¿å…¥åŠ›</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          padding: 15px;
          max-width: 400px;
          margin: auto;
          background-color: #f4f4f9;
        }
        h2 {
          text-align: center;
          color: #333;
        }
        
        label, input, select {
          display: block; 
          width: 100%; 
          box-sizing: border-box;
          margin: 0; 
        }
        
        .input-group {
          margin-bottom: 15px;
        }

        .input-group label {
            font-weight: bold;
            margin-bottom: 5px; 
            padding: 0;
            border: none;
        }

        .input-group input, 
        .input-group select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 0; 
        }
        
        button {
          background-color: #4CAF50;
          color: white;
          padding: 14px 20px;
          margin: 8px 0;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          width: 100%;
          font-size: 16px;
        }
        button:hover {
          background-color: #45a049;
        }
        #loading {
          display: none;
          text-align: center;
          color: #666;
        }

        /* é›†è¨ˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #summary-area {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .month-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .month-btn {
            background-color: #ddd;
            color: #333;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            width: auto;
            font-size: 14px;
        }
        .month-btn:hover {
            background-color: #ccc;
        }
      </style>
  </head>
<body>

  <h2>ğŸ’¸ å®¶è¨ˆç°¿</h2>

  <form id="kakeiboForm">

    <div class="input-group">
      <label for="date">æ—¥ä»˜ (å¿…é ˆ)</label>
      <input type="date" id="date" name="date" required>
    </div>

    <div class="input-group">
      <label for="amount">é‡‘é¡ (å¿…é ˆ)</label>
      <input type="number" id="amount" name="amount" required placeholder="0">
    </div>

    <div class="input-group">
      <label for="item">è²»ç›®</label>
      <select id="item" name="item">
        <option value="é£Ÿè²»">é£Ÿè²»</option>
        <option value="äº¤é€šè²»">äº¤é€šè²»</option>
        <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
        <option value="å¨¯æ¥½">å¨¯æ¥½</option>
        <option value="ç¾å®¹ä»£">ç¾å®¹ä»£</option>
        <option value="é€šä¿¡è²»">é€šä¿¡è²»</option>
        <option value="äº¤éš›è²»">äº¤éš›è²»</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
        <option value="åå…¥">åå…¥</option>
      </select>
    </div>

    <div class="input-group">
      <label for="memo">ãƒ¡ãƒ¢</label>
      <input type="text" id="memo" name="memo">
    </div>

    <button type="button" onclick="submitForm()">ç™»éŒ²</button>
  </form>

  <p id="loading">å‡¦ç†ä¸­...</p>

  <hr>

  <div id="summary-area">
    <!-- æœˆåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
    <div class="month-selector">
        <button class="month-btn" onclick="changeMonth(-1)">â¬…ï¸ å…ˆæœˆ</button>
        <h3 id="current-month-display" style="margin: 0;"></h3>
        <button class="month-btn" onclick="changeMonth(1)">ç¿Œæœˆ â¡ï¸</button>
    </div>

    <div id="loading-summary">é›†è¨ˆä¸­...</div>
    
    <div id="summary-content" style="display: none;">
        <p><strong>ç·æ”¯å‡º: </strong><span id="monthly-total-expense">0å††</span></p>
        <!-- åå…¥ã¯æ§ãˆã‚ã«è¡¨ç¤º -->
        <p style="font-size: 0.9em; color: #666;">(ç·åå…¥: <span id="monthly-total-income">0å††</span>)</p>
        
        <h4>è²»ç›®åˆ¥å‰²åˆ (æ”¯å‡º):</h4>
        <ul id="breakdown-list">
            </ul>
    </div>
  </div>
  
  <p id="summary-error" style="color: red; display: none;"></p>

  <script>
    // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹é›†è¨ˆã®å¹´æœˆ
    let displayYear;
    let displayMonth;

    // å®‰å…¨ã«GASé–¢æ•°ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼
    function callGas(method, successHandler, ...args) {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run.withSuccessHandler(successHandler)[method](...args);
      } else {
        console.warn(`google.script.run.${method} called outside of GAS environment.`);
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒç­‰ã§ã®ãƒ¢ãƒƒã‚¯å‹•ä½œ
        const mockData = {
          recordKakeibo: "GASç’°å¢ƒå¤–ã®ãŸã‚è¨˜éŒ²ã•ã‚Œã¾ã›ã‚“ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰",
          getMonthlySummary: { 
            year: args[0], month: args[1], 
            totalExpense: "---", totalIncome: "---", breakdown: {}, 
            error: "GASç’°å¢ƒå¤–ã§ã™ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®URLã§å‹•ä½œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" 
          }
        };
        setTimeout(() => successHandler(mockData[method]), 500);
      }
    }

    function submitForm() {
      const form = document.getElementById('kakeiboForm');
      const date = document.getElementById('date').value;
      const amount = document.getElementById('amount').value;

      if (!date) { alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      if (!amount) { alert('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      
      const formData = {
        date: form.date.value,
        amount: form.amount.value,
        item: form.item.value,
        memo: form.memo.value
      };
      
      form.style.display = 'none';
      document.getElementById('loading').style.display = 'block';

      callGas('recordKakeibo', handleResponse, formData);
    }

    function handleResponse(response) {
      alert(response); 
      document.getElementById('kakeiboForm').reset();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('kakeiboForm').style.display = 'block';
      
      // æ—¥ä»˜ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆï¼‰
      setTodayDate();
      
      // ç™»éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦ã€ä»Šæœˆã®é›†è¨ˆã‚’å†èª­ã¿è¾¼ã¿
      resetToCurrentMonth();
    }

    // --- é›†è¨ˆé–¢é€£ã®å‡¦ç† ---

    function resetToCurrentMonth() {
        const now = new Date();
        displayYear = now.getFullYear();
        displayMonth = now.getMonth() + 1; 
        loadSummary(displayYear, displayMonth);
    }

    function changeMonth(offset) {
        displayMonth += offset;
        
        if (displayMonth < 1) {
            displayMonth = 12;
            displayYear--;
        } else if (displayMonth > 12) {
            displayMonth = 1;
            displayYear++;
        }
        
        loadSummary(displayYear, displayMonth);
    }

    function loadSummary(year, month) {
      document.getElementById('loading-summary').style.display = 'block';
      document.getElementById('summary-content').style.display = 'none';
      document.getElementById('summary-error').style.display = 'none';
      
      document.getElementById('current-month-display').textContent = `${year}å¹´ ${month}æœˆ`;

      callGas('getMonthlySummary', displaySummary, year, month);
    }

    function displaySummary(summaryData) {
      document.getElementById('loading-summary').style.display = 'none';

      if (summaryData.error) {
          document.getElementById('summary-error').textContent = summaryData.error;
          document.getElementById('summary-error').style.display = 'block';
          // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ä¸€éƒ¨è¡¨ç¤ºã™ã‚‹ãŸã‚ã«contentã‚’å‡ºã™
          document.getElementById('summary-content').style.display = 'block';
          return;
      }
      
      document.getElementById('summary-content').style.display = 'block';
      document.getElementById('monthly-total-expense').textContent = summaryData.totalExpense + 'å††';
      document.getElementById('monthly-total-income').textContent = summaryData.totalIncome + 'å††';

      const breakdownList = document.getElementById('breakdown-list');
      breakdownList.innerHTML = ''; 
      
      const breakdown = summaryData.breakdown;
      
      if (!breakdown || Object.keys(breakdown).length === 0) {
          breakdownList.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
          return; 
      }
      
      const sortedCategories = Object.keys(breakdown).sort((a, b) => {
          const percB = parseFloat(breakdown[b].percentage);
          const percA = parseFloat(breakdown[a].percentage);
          return percB - percA;
      });

      sortedCategories.forEach(item => {
          const data = breakdown[item];
          const li = document.createElement('li');
          li.textContent = `${item}: ${data.amount}å†† (${data.percentage}%)`;
          breakdownList.appendChild(li);
      });
    }

    function setTodayDate() {
        const now = new Date(); // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ï¼ˆJSTï¼‰ã‚’å–å¾—
        const yyyy = now.getFullYear();
        const mm = ('0' + (now.getMonth() + 1)).slice(-2);
        const dd = ('0' + now.getDate()).slice(-2);
        
        // æ–‡å­—åˆ—ã¨ã—ã¦ã‚»ãƒƒãƒˆã™ã‚‹ã“ã¨ã§ã€ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®ã‚ºãƒ¬ã‚’é˜²ã2026å¹´ã‚’è¡¨ç¤º
        document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
    }

    window.onload = function() {
      setTodayDate();
      resetToCurrentMonth();
    };
  </script>
</body>
</html>