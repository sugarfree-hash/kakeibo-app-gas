<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è¨ˆç°¿å…¥åŠ›</title>
      <style>
        /* ç°¡æ˜“çš„ãªCSSã§ã‚¹ãƒãƒ›å‘ã‘ã«èª¿æ•´ */
        body {
          font-family: Arial, sans-serif;
          padding: 15px;
          max-width: 400px;
          margin: auto;
          background-color: #f4f4f9;
        }
        h2 {
          text-align: center;
          color: #333;
        }
        
        /* â˜…â˜…â˜… æœ€çµ‚ä¿®æ­£ï¼šã™ã¹ã¦ã®ãƒ©ãƒ™ãƒ«ã€å…¥åŠ›ã€é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã«è¨­å®š â˜…â˜…â˜… */
        /* å„è¦ç´ ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ãŸã‚ã®åŸºæœ¬è¨­å®š */
        label, input, select {
          display: block; /* å¼·åˆ¶çš„ã«ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã«ã—ã€å¿…ãšæ”¹è¡Œã•ã›ã‚‹ */
          width: 100%; 
          box-sizing: border-box;
          margin: 0; 
        }
        
        /* å…¥åŠ›ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã®ä½™ç™½ã‚’è¨­å®š */
        .input-group {
          margin-bottom: 15px;
        }

        /* ãƒ©ãƒ™ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .input-group label {
            font-weight: bold;
            margin-bottom: 5px; 
            padding: 0;
            border: none;
        }

        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®è¦‹ãŸç›®ã‚’èª¿æ•´ */
        .input-group input[type="number"], 
        .input-group input[type="text"], 
        .input-group input[type="date"], 
        .input-group select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 0; /* ãƒ©ãƒ™ãƒ«ã¨ã®é–“ã¯margin-bottom: 5px;ã§èª¿æ•´ */
        }
        
        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥ï¼ˆå‰å›ã¨åŒã˜ï¼‰ */
        button {
          background-color: #4CAF50;
          color: white;
          padding: 14px 20px;
          margin: 8px 0;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          width: 100%;
          font-size: 16px;
        }
        button:hover {
          background-color: #45a049;
        }
        #loading {
          display: none;
          text-align: center;
          color: #666;
        }
      </style>
  </head>
<body>

  <h2>ğŸ’¸ å®¶è¨ˆç°¿</h2>

  <form id="kakeiboForm">

    <div class="input-group">
      <label for="date">æ—¥ä»˜ (å¿…é ˆ)</label>
      <input type="date" id="date" name="date" required>
    </div>

    <div class="input-group">
      <label for="amount">é‡‘é¡ (å¿…é ˆ)</label>
      <input type="number" id="amount" name="amount" required placeholder="0">
    </div>

    <div class="input-group">
      <label for="item">è²»ç›®</label>
      <select id="item" name="item">
        <option value="é£Ÿè²»">é£Ÿè²»</option>
        <option value="äº¤é€šè²»">äº¤é€šè²»</option>
        <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
        <option value="å¨¯æ¥½">å¨¯æ¥½</option>
        <option value="ç¾å®¹ä»£">ç¾å®¹ä»£</option>
        <option value="é€šä¿¡è²»">é€šä¿¡è²»</option>
        <option value="äº¤éš›è²»">äº¤éš›è²»</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
        <option value="åå…¥">åå…¥</option>
      </select>
    </div>

    <div class="input-group">
      <label for="memo">ãƒ¡ãƒ¢</label>
      <input type="text" id="memo" name="memo">
    </div>

    <button type="button" onclick="submitForm()">ç™»éŒ²</button>
  </form>

  <p id="loading">å‡¦ç†ä¸­...</p>

  <hr>

  <div id="summary-area">
    <h3>ä»Šæœˆã®æ”¯å‡º</h3>
    <p id="current-month-display"></p>
    <div id="loading-summary">é›†è¨ˆä¸­...</div>
    <div id="summary-content" style="display: none;">
        <p><strong>ç·é¡: </strong><span id="monthly-total">0å††</span></p>
        <h4>è²»ç›®åˆ¥å‰²åˆ:</h4>
        <ul id="breakdown-list">
            </ul>
    </div>
  </div>
  
  <p id="summary-error" style="color: red; display: none;"></p>

  <script>
    /**
     * ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€GASã‚µãƒ¼ãƒãƒ¼å´é–¢æ•°ã‚’å‘¼ã³å‡ºã™
     */
    function submitForm() {
      const form = document.getElementById('kakeiboForm');
      const date = document.getElementById('date').value;
      const amount = document.getElementById('amount').value;

      // é‡‘é¡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      if (!date) {
        alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // é‡‘é¡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      if (!amount) {
        alert('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å–å¾—
      const formData = {
        date: form.date.value,
        amount: form.amount.value,
        item: form.item.value,
        memo: form.memo.value
      };
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«ã—ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      form.style.display = 'none';
      document.getElementById('loading').style.display = 'block';

      // ã‚µãƒ¼ãƒãƒ¼å´ã®recordKakeiboé–¢æ•°ã‚’éåŒæœŸã§å®Ÿè¡Œã—ã€çµæœã‚’handleResponseã§å—ã‘å–ã‚‹
      google.script.run
        .withSuccessHandler(handleResponse)
        .recordKakeibo(formData);
    }

    /**
     * GASã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰ã®å¿œç­”ã‚’å‡¦ç†ã™ã‚‹
     * @param {string} response - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    function handleResponse(response) {
      alert(response); // æˆåŠŸã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€å†è¡¨ç¤º
      document.getElementById('kakeiboForm').reset();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('kakeiboForm').style.display = 'block';
    }

    // index.html (æ—¢å­˜ã® JavaScriptã‚³ãƒ¼ãƒ‰ã®ä¸‹ã«è¿½åŠ )

  /**
  * GASã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ç”»é¢ã«è¡¨ç¤ºã™ã‚‹
  */
  function loadSummary() {
    document.getElementById('loading-summary').style.display = 'block';
    document.getElementById('summary-content').style.display = 'none';
    document.getElementById('summary-error').style.display = 'none';
    
    // ç¾åœ¨ã®å¹´æœˆã‚’è¡¨ç¤º
    const now = new Date();
    const month = now.getMonth() + 1;
    const year = now.getFullYear();
    document.getElementById('current-month-display').textContent = `${year}å¹´ ${month}æœˆ`;

    google.script.run
        .withSuccessHandler(displaySummary)
        .getMonthlySummary();
  }

  /**
  * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸé›†è¨ˆçµæœã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹
  * @param {object} summaryData - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®é›†è¨ˆãƒ‡ãƒ¼ã‚¿
  */
  function displaySummary(summaryData) {
    document.getElementById('loading-summary').style.display = 'none';

    if (summaryData.error) {
        document.getElementById('summary-error').textContent = 'é›†è¨ˆã‚¨ãƒ©ãƒ¼: ' + summaryData.error;
        document.getElementById('summary-error').style.display = 'block';
        return;
    }
    
    document.getElementById('summary-content').style.display = 'block';
    
    // 1. ç·é¡ã®è¡¨ç¤º
    document.getElementById('monthly-total').textContent = summaryData.totalExpense + 'å††';

    // 2. è²»ç›®åˆ¥å‰²åˆã®è¡¨ç¤º
    const breakdownList = document.getElementById('breakdown-list');
    breakdownList.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    
    const breakdown = summaryData.breakdown;

    // ç·æ”¯å‡ºãŒ0å††ã®å ´åˆã®è¡¨ç¤ºã‚’ã“ã“ã§ã‚¬ãƒ¼ãƒ‰
    if (Object.keys(breakdown).length === 0) {
        breakdownList.textContent = 'ä»Šæœˆã€ã¾ã æ”¯å‡ºã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
        return; 
    }
    
    // å‰²åˆãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
    const sortedCategories = Object.keys(breakdown).sort((a, b) => {
      // ä¿®æ­£ç®‡æ‰€: æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›ã—ã¦æ¯”è¼ƒã™ã‚‹
      const percB = parseFloat(breakdown[b].percentage);
      const percA = parseFloat(breakdown[a].percentage);
      return percB - percA;
    });

    sortedCategories.forEach(item => {
        const data = breakdown[item];
        const li = document.createElement('li');
        li.textContent = `${item}: ${data.amount}å†† (${data.percentage}%)`;
        breakdownList.appendChild(li);
    });
  }

  // æ—¢å­˜ã® window.onload é–¢æ•°ã«é›†è¨ˆå‡¦ç†ã‚’è¿½åŠ 
  window.onload = function() {
    document.getElementById('date').valueAsDate = new Date();
    loadSummary(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«é›†è¨ˆã‚’å‘¼ã³å‡ºã™
  };

  // æ—¢å­˜ã® handleResponse é–¢æ•°ã«ã‚‚é›†è¨ˆå‡¦ç†ã‚’è¿½åŠ  (ãƒ‡ãƒ¼ã‚¿ç™»éŒ²å¾Œ)
  function handleResponse(response) {
    alert(response); 
    document.getElementById('kakeiboForm').reset();
    document.getElementById('loading').style.display = 'none';
    document.getElementById('kakeiboForm').style.display = 'block';
    document.getElementById('date').valueAsDate = new Date();
    
    loadSummary(); // ãƒ‡ãƒ¼ã‚¿ç™»éŒ²å¾Œã€é›†è¨ˆã‚’æ›´æ–°ã™ã‚‹
  }
  </script>
</body>
</html>